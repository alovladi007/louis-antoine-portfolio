<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Backend Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .connected {
            background: #0f4c0f;
            color: #00ff00;
        }
        .disconnected {
            background: #4c0f0f;
            color: #ff0000;
        }
        .log {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #0088ff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0066cc;
        }
        .robot-info {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Robot Backend Connection Test</h1>
    
    <div id="status" class="status disconnected">
        WebSocket: Disconnected
    </div>
    
    <div id="api-status" class="status disconnected">
        REST API: Not Tested
    </div>
    
    <div>
        <button onclick="testAPI()">Test REST API</button>
        <button onclick="connectWebSocket()">Connect WebSocket</button>
        <button onclick="sendJogCommand()">Send Jog Command</button>
        <button onclick="homeRobot()">Home Robot</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="robot-info" class="robot-info">
        <h3>Robot Status</h3>
        <div id="robot-data">No data yet...</div>
    </div>
    
    <h3>Connection Log</h3>
    <div id="log" class="log"></div>
    
    <script>
        let ws = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#e0e0e0';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testAPI() {
            try {
                log('Testing REST API at http://localhost:4000/api/robots...');
                const response = await fetch('http://localhost:4000/api/robots');
                const data = await response.json();
                
                document.getElementById('api-status').className = 'status connected';
                document.getElementById('api-status').textContent = 'REST API: Connected ✓';
                
                log(`API Response: Found ${data.length} robots`, 'success');
                
                // Display robot info
                const robotInfo = document.getElementById('robot-data');
                robotInfo.innerHTML = data.map(robot => `
                    <div>
                        <strong>${robot.name}</strong>: 
                        Status: ${robot.status}, 
                        Health: ${robot.health.toFixed(1)}%, 
                        Position: [${robot.controller.cartesianPosition.map(p => p.toFixed(3)).join(', ')}]
                    </div>
                `).join('');
                
            } catch (error) {
                document.getElementById('api-status').className = 'status disconnected';
                document.getElementById('api-status').textContent = 'REST API: Failed ✗';
                log(`API Error: ${error.message}`, 'error');
            }
        }
        
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocket already connected');
                return;
            }
            
            try {
                log('Connecting to WebSocket at ws://localhost:4001...');
                ws = new WebSocket('ws://localhost:4001');
                
                ws.onopen = () => {
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = 'WebSocket: Connected ✓';
                    log('WebSocket connected successfully!', 'success');
                    
                    // Subscribe to robot control
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        channel: 'robot_control'
                    }));
                    log('Subscribed to robot_control channel');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    log(`Received: ${data.type}`);
                    
                    if (data.type === 'robot_states') {
                        const states = data.payload;
                        const robotInfo = document.getElementById('robot-data');
                        robotInfo.innerHTML = Object.entries(states).map(([id, state]) => `
                            <div>
                                <strong>${id}</strong>: 
                                Joints: [${state.jointPositions.map(j => j.toFixed(2)).join(', ')}],
                                Executing: ${state.isExecuting}
                            </div>
                        `).join('');
                    }
                };
                
                ws.onerror = (error) => {
                    log(`WebSocket error: ${error}`, 'error');
                };
                
                ws.onclose = () => {
                    document.getElementById('status').className = 'status disconnected';
                    document.getElementById('status').textContent = 'WebSocket: Disconnected ✗';
                    log('WebSocket disconnected', 'error');
                };
                
            } catch (error) {
                log(`Connection error: ${error.message}`, 'error');
            }
        }
        
        function sendJogCommand() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket not connected!', 'error');
                return;
            }
            
            const command = {
                type: 'robot_jog',
                robotId: 'robot-001',
                axis: 0,
                direction: 1,
                speed: 0.5
            };
            
            ws.send(JSON.stringify(command));
            log(`Sent jog command: axis=0, direction=1, speed=0.5`);
        }
        
        function homeRobot() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket not connected!', 'error');
                return;
            }
            
            const command = {
                type: 'robot_home',
                robotId: 'robot-001'
            };
            
            ws.send(JSON.stringify(command));
            log('Sent home command for robot-001');
        }
        
        // Auto-test on load
        window.onload = () => {
            log('Page loaded. Testing connections...');
            testAPI();
            setTimeout(connectWebSocket, 1000);
        };
    </script>
</body>
</html>