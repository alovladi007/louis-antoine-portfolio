<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defect Inspection Lab - Multi-Algorithm Detection System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.8.0/simple-statistics.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 212, 255, 0.05));
            border-radius: 20px;
        }
        
        h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        
        .inspection-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 2rem;
        }
        
        .control-panel {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            height: fit-content;
        }
        
        .main-viewer {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
        }
        
        .defect-list {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .section-title {
            color: #00d4ff;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group label {
            display: block;
            color: #00d4ff;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .control-group input[type="range"],
        .control-group select {
            width: 100%;
            padding: 0.5rem;
            background: #222;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 5px;
        }
        
        .value-display {
            text-align: right;
            color: #888;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        .btn {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 0.5rem;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid #00d4ff;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5rem;
            color: #00d4ff;
            font-weight: bold;
        }
        
        .metric-label {
            color: #888;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        .defect-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .defect-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
        }
        
        .defect-item.selected {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }
        
        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .defect-id {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .defect-type {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .defect-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #888;
        }
        
        .viewer-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            background: #222;
            border: 1px solid #444;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-color: #00d4ff;
        }
        
        .algorithm-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .algorithm-option {
            padding: 0.5rem;
            background: #222;
            border: 1px solid #444;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .algorithm-option.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .status-indicator.processing {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Defect Inspection Laboratory</h1>
            <p>Advanced Multi-Algorithm Defect Detection and Classification System</p>
        </div>
        
        <div class="inspection-layout">
            <div class="control-panel">
                <h3 class="section-title">
                    <i class="fas fa-sliders-h"></i> Detection Parameters
                </h3>
                
                <div class="control-group">
                    <label>Detection Algorithm</label>
                    <div class="algorithm-selector">
                        <div class="algorithm-option active" onclick="selectAlgorithm('die2die')">Die-to-Die</div>
                        <div class="algorithm-option" onclick="selectAlgorithm('die2db')">Die-to-DB</div>
                        <div class="algorithm-option" onclick="selectAlgorithm('cell2cell')">Cell-to-Cell</div>
                        <div class="algorithm-option" onclick="selectAlgorithm('ml')">ML-Based</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Sensitivity: <span id="sens-val">50</span>%</label>
                    <input type="range" id="sensitivity" min="0" max="100" value="50" oninput="updateValue('sens'); runInspection()">
                </div>
                
                <div class="control-group">
                    <label>Threshold: <span id="thresh-val">0.1</span></label>
                    <input type="range" id="threshold" min="0.01" max="1" step="0.01" value="0.1" oninput="updateValue('thresh'); runInspection()">
                </div>
                
                <div class="control-group">
                    <label>Min Size (nm): <span id="size-val">10</span></label>
                    <input type="range" id="min-size" min="5" max="100" value="10" oninput="updateValue('size'); runInspection()">
                </div>
                
                <div class="control-group">
                    <label>Inspection Mode</label>
                    <select id="mode" onchange="runInspection()">
                        <option value="brightfield">Brightfield</option>
                        <option value="darkfield">Darkfield</option>
                        <option value="phase">Phase Contrast</option>
                        <option value="sem">SEM</option>
                    </select>
                </div>
                
                <button class="btn" onclick="runInspection()">
                    <i class="fas fa-search"></i> Run Inspection
                </button>
                
                <button class="btn btn-secondary" onclick="generateDefects()">
                    <i class="fas fa-random"></i> Generate Test Defects
                </button>
                
                <button class="btn btn-secondary" onclick="clearDefects()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
                
                <button class="btn btn-secondary" onclick="exportDefects()">
                    <i class="fas fa-download"></i> Export KLARF
                </button>
            </div>
            
            <div class="main-viewer">
                <h3 class="section-title">
                    <i class="fas fa-microscope"></i> Inspection Viewer
                </h3>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="total-defects">0</div>
                        <div class="metric-label">Total Defects</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="defect-density">0.00</div>
                        <div class="metric-label">Density (/cm²)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="yield-impact">100</div>
                        <div class="metric-label">Yield Impact (%)</div>
                    </div>
                </div>
                
                <div class="viewer-tabs">
                    <div class="tab active" onclick="switchView('wafer')">Wafer Map</div>
                    <div class="tab" onclick="switchView('heatmap')">Defect Heatmap</div>
                    <div class="tab" onclick="switchView('size')">Size Distribution</div>
                    <div class="tab" onclick="switchView('pareto')">Pareto Analysis</div>
                </div>
                
                <div id="wafer-view" style="display: block;">
                    <div id="wafer-map"></div>
                </div>
                
                <div id="heatmap-view" style="display: none;">
                    <div id="defect-heatmap"></div>
                </div>
                
                <div id="size-view" style="display: none;">
                    <div id="size-distribution"></div>
                </div>
                
                <div id="pareto-view" style="display: none;">
                    <div id="pareto-chart"></div>
                </div>
                
                <div class="status-bar">
                    <span class="status-indicator" id="status"></span>
                    <span id="status-text">Ready</span>
                    <span style="margin-left: auto;">Last inspection: <span id="timestamp">--</span></span>
                </div>
            </div>
            
            <div class="defect-list">
                <h3 class="section-title">
                    <i class="fas fa-list"></i> Defect List
                </h3>
                
                <div style="margin-bottom: 1rem;">
                    <input type="text" placeholder="Search defects..." style="width: 100%; padding: 0.5rem; background: #222; border: 1px solid #444; color: #e0e0e0; border-radius: 5px;">
                </div>
                
                <div id="defect-items">
                    <!-- Defect items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentView = 'wafer';
        let selectedAlgorithm = 'die2die';
        let defects = [];
        let waferData = null;
        
        function updateValue(param) {
            const element = document.getElementById(param === 'sens' ? 'sensitivity' : 
                                                   param === 'thresh' ? 'threshold' : 
                                                   param === 'size' ? 'min-size' : param);
            const value = element.value;
            const suffix = param === 'sens' ? '%' : param === 'size' ? '' : '';
            document.getElementById(param + '-val').textContent = value + suffix;
        }
        
        function selectAlgorithm(algo) {
            selectedAlgorithm = algo;
            document.querySelectorAll('.algorithm-option').forEach(opt => opt.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('[id$="-view"]').forEach(v => v.style.display = 'none');
            document.getElementById(view + '-view').style.display = 'block';
            
            updateVisualization();
        }
        
        function generateWaferPattern() {
            const size = 200;
            const wafer = [];
            
            // Generate clean wafer pattern
            for (let i = 0; i < size; i++) {
                let row = [];
                for (let j = 0; j < size; j++) {
                    // Circular wafer boundary
                    const cx = size / 2;
                    const cy = size / 2;
                    const r = size / 2 - 10;
                    const dist = Math.sqrt((i - cy) ** 2 + (j - cx) ** 2);
                    
                    if (dist < r) {
                        // Die pattern
                        const dieX = Math.floor(j / 20);
                        const dieY = Math.floor(i / 20);
                        const inDie = (j % 20 > 1 && j % 20 < 19) && (i % 20 > 1 && i % 20 < 19);
                        row.push(inDie ? 0.8 : 0.4);
                    } else {
                        row.push(0);
                    }
                }
                wafer.push(row);
            }
            
            return wafer;
        }
        
        function generateDefects() {
            defects = [];
            waferData = generateWaferPattern();
            
            const sensitivity = parseFloat(document.getElementById('sensitivity').value) / 100;
            const numDefects = Math.floor(10 + sensitivity * 40);
            
            const defectTypes = ['Particle', 'Scratch', 'Pattern', 'Void', 'Bridge', 'Residue', 'Discoloration'];
            const defectSeverity = ['Critical', 'Major', 'Minor'];
            
            for (let i = 0; i < numDefects; i++) {
                const x = Math.random() * 180 + 10;
                const y = Math.random() * 180 + 10;
                const size = Math.random() * 50 + 10;
                
                // Add defect to wafer data
                const wx = Math.floor(x);
                const wy = Math.floor(y);
                const defectRadius = Math.floor(size / 10);
                
                for (let dy = -defectRadius; dy <= defectRadius; dy++) {
                    for (let dx = -defectRadius; dx <= defectRadius; dx++) {
                        if (wy + dy >= 0 && wy + dy < 200 && wx + dx >= 0 && wx + dx < 200) {
                            if (Math.sqrt(dx*dx + dy*dy) <= defectRadius) {
                                waferData[wy + dy][wx + dx] = 1;
                            }
                        }
                    }
                }
                
                defects.push({
                    id: `D${String(i + 1).padStart(4, '0')}`,
                    x: x,
                    y: y,
                    size: size,
                    type: defectTypes[Math.floor(Math.random() * defectTypes.length)],
                    severity: defectSeverity[Math.floor(Math.random() * defectSeverity.length)],
                    confidence: 0.7 + Math.random() * 0.3,
                    dieX: Math.floor(x / 20),
                    dieY: Math.floor(y / 20),
                    detected: new Date().toISOString()
                });
            }
            
            updateMetrics();
            updateDefectList();
            updateVisualization();
        }
        
        function runInspection() {
            document.getElementById('status').classList.add('processing');
            document.getElementById('status-text').textContent = 'Inspecting...';
            
            setTimeout(() => {
                generateDefects();
                document.getElementById('status').classList.remove('processing');
                document.getElementById('status-text').textContent = 'Inspection Complete';
                document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
            }, 2000);
        }
        
        function updateMetrics() {
            const totalDefects = defects.length;
            const waferArea = Math.PI * 9 * 9; // 300mm wafer in cm²
            const defectDensity = (totalDefects / waferArea).toFixed(2);
            const yieldImpact = Math.max(0, 100 - totalDefects * 2).toFixed(1);
            
            document.getElementById('total-defects').textContent = totalDefects;
            document.getElementById('defect-density').textContent = defectDensity;
            document.getElementById('yield-impact').textContent = yieldImpact;
        }
        
        function updateDefectList() {
            const container = document.getElementById('defect-items');
            container.innerHTML = '';
            
            defects.forEach(defect => {
                const item = document.createElement('div');
                item.className = 'defect-item';
                item.onclick = () => selectDefect(defect.id);
                
                const severityColor = defect.severity === 'Critical' ? '#ef4444' :
                                     defect.severity === 'Major' ? '#f59e0b' : '#10b981';
                
                item.innerHTML = `
                    <div class="defect-header">
                        <span class="defect-id">${defect.id}</span>
                        <span class="defect-type">${defect.type}</span>
                    </div>
                    <div class="defect-details">
                        <span>Size: ${defect.size.toFixed(1)}nm</span>
                        <span>Die: (${defect.dieX}, ${defect.dieY})</span>
                        <span>Severity: <span style="color: ${severityColor}">${defect.severity}</span></span>
                        <span>Conf: ${(defect.confidence * 100).toFixed(0)}%</span>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function updateVisualization() {
            switch(currentView) {
                case 'wafer':
                    plotWaferMap();
                    break;
                case 'heatmap':
                    plotDefectHeatmap();
                    break;
                case 'size':
                    plotSizeDistribution();
                    break;
                case 'pareto':
                    plotParetoChart();
                    break;
            }
        }
        
        function plotWaferMap() {
            if (!waferData) {
                waferData = generateWaferPattern();
            }
            
            // Add defect markers
            const defectX = defects.map(d => d.x);
            const defectY = defects.map(d => d.y);
            const defectSizes = defects.map(d => d.size / 5);
            const defectColors = defects.map(d => 
                d.severity === 'Critical' ? '#ef4444' :
                d.severity === 'Major' ? '#f59e0b' : '#10b981'
            );
            
            const waferTrace = {
                z: waferData,
                type: 'heatmap',
                colorscale: [[0, '#000'], [0.4, '#222'], [0.8, '#444'], [1, '#f00']],
                showscale: false
            };
            
            const defectTrace = {
                x: defectX,
                y: defectY,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: defectSizes,
                    color: defectColors,
                    line: { width: 1, color: '#fff' }
                },
                hovertemplate: 'X: %{x}<br>Y: %{y}<extra></extra>'
            };
            
            Plotly.newPlot('wafer-map', [waferTrace, defectTrace], {
                title: 'Wafer Defect Map',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'X Position (mm)' },
                yaxis: { title: 'Y Position (mm)' },
                showlegend: false
            });
        }
        
        function plotDefectHeatmap() {
            // Create density heatmap
            const size = 50;
            const heatmap = Array(size).fill().map(() => Array(size).fill(0));
            
            defects.forEach(defect => {
                const x = Math.floor(defect.x / 4);
                const y = Math.floor(defect.y / 4);
                if (x >= 0 && x < size && y >= 0 && y < size) {
                    heatmap[y][x]++;
                }
            });
            
            // Apply Gaussian blur for smooth heatmap
            for (let i = 1; i < size - 1; i++) {
                for (let j = 1; j < size - 1; j++) {
                    const sum = heatmap[i-1][j-1] + heatmap[i-1][j] + heatmap[i-1][j+1] +
                               heatmap[i][j-1] + heatmap[i][j] * 4 + heatmap[i][j+1] +
                               heatmap[i+1][j-1] + heatmap[i+1][j] + heatmap[i+1][j+1];
                    heatmap[i][j] = sum / 12;
                }
            }
            
            Plotly.newPlot('defect-heatmap', [{
                z: heatmap,
                type: 'heatmap',
                colorscale: 'Hot',
                colorbar: { title: 'Defect Density' }
            }], {
                title: 'Defect Density Heatmap',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' }
            });
        }
        
        function plotSizeDistribution() {
            const sizes = defects.map(d => d.size);
            
            Plotly.newPlot('size-distribution', [{
                x: sizes,
                type: 'histogram',
                nbinsx: 20,
                marker: { color: '#00d4ff' }
            }], {
                title: 'Defect Size Distribution',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Size (nm)' },
                yaxis: { title: 'Count' }
            });
        }
        
        function plotParetoChart() {
            // Count defects by type
            const typeCounts = {};
            defects.forEach(d => {
                typeCounts[d.type] = (typeCounts[d.type] || 0) + 1;
            });
            
            // Sort by count
            const sorted = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
            const types = sorted.map(s => s[0]);
            const counts = sorted.map(s => s[1]);
            
            // Calculate cumulative percentage
            const total = counts.reduce((a, b) => a + b, 0);
            let cumulative = 0;
            const cumulativePercent = counts.map(c => {
                cumulative += c;
                return (cumulative / total) * 100;
            });
            
            const barTrace = {
                x: types,
                y: counts,
                type: 'bar',
                name: 'Count',
                marker: { color: '#00d4ff' },
                yaxis: 'y'
            };
            
            const lineTrace = {
                x: types,
                y: cumulativePercent,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Cumulative %',
                line: { color: '#10b981', width: 2 },
                marker: { size: 8 },
                yaxis: 'y2'
            };
            
            Plotly.newPlot('pareto-chart', [barTrace, lineTrace], {
                title: 'Defect Pareto Analysis',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Defect Type' },
                yaxis: { title: 'Count', side: 'left' },
                yaxis2: { title: 'Cumulative %', side: 'right', overlaying: 'y', range: [0, 100] },
                showlegend: true
            });
        }
        
        function selectDefect(id) {
            document.querySelectorAll('.defect-item').forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            const defect = defects.find(d => d.id === id);
            if (defect) {
                // Zoom to defect on wafer map
                // In a real implementation, this would update the view
                console.log('Selected defect:', defect);
            }
        }
        
        function clearDefects() {
            defects = [];
            waferData = generateWaferPattern();
            updateMetrics();
            updateDefectList();
            updateVisualization();
        }
        
        function exportDefects() {
            const klarf = {
                FileVersion: '1.2',
                FileTimestamp: new Date().toISOString(),
                InspectionStationID: 'Virtual Inspector',
                SampleType: 'WAFER',
                ResultTimestamp: new Date().toISOString(),
                LotID: 'LOT001',
                WaferID: 'W001',
                DefectList: defects.map(d => ({
                    DefectID: d.id,
                    XREL: d.x,
                    YREL: d.y,
                    XINDEX: d.dieX,
                    YINDEX: d.dieY,
                    XSIZE: d.size,
                    YSIZE: d.size,
                    DEFECTAREA: Math.PI * (d.size/2) ** 2,
                    DSIZE: d.size,
                    CLASSNUMBER: d.type,
                    TEST: d.confidence
                }))
            };
            
            const blob = new Blob([JSON.stringify(klarf, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'defects.klarf';
            a.click();
        }
        
        // Initialize
        window.onload = function() {
            waferData = generateWaferPattern();
            plotWaferMap();
        };
    </script>
</body>
</html>