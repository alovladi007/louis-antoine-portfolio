<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCM I-V Characteristics Lab - Threshold Switching Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(147, 51, 234, 0.3);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .title-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #9333ea, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .lab-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .controls-panel {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 15px;
            padding: 2rem;
            height: fit-content;
        }

        .plots-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .plot-container {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            min-height: 400px;
        }

        .plot-container.full-width {
            grid-column: span 2;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: block;
            color: #c084fc;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .control-value {
            color: #9333ea;
            font-weight: bold;
            float: right;
        }

        .control-slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 5px;
            background: rgba(147, 51, 234, 0.2);
            outline: none;
            border-radius: 5px;
            margin-top: 0.5rem;
        }

        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #9333ea;
            cursor: pointer;
            border-radius: 50%;
        }

        .btn {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(147, 51, 234, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #9333ea;
            color: #9333ea;
        }

        .state-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .state-btn {
            background: rgba(147, 51, 234, 0.1);
            border: 2px solid rgba(147, 51, 234, 0.3);
            color: #c084fc;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
        }

        .state-btn.active {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
            border-color: transparent;
        }

        .info-panel {
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(147, 51, 234, 0.1);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(147, 51, 234, 0.2);
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            color: #c084fc;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #9333ea, #c084fc);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .sweep-mode {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .sweep-btn {
            flex: 1;
            padding: 0.5rem;
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.3);
            color: #c084fc;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sweep-btn.active {
            background: rgba(147, 51, 234, 0.3);
        }

        @media (max-width: 1024px) {
            .lab-container {
                grid-template-columns: 1fr;
            }
            
            .plots-grid {
                grid-template-columns: 1fr;
            }
            
            .plot-container.full-width {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h2 style="color: #c084fc;">I-V Characteristics Laboratory</h2>
            <a href="pcm-complete-project.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to PCM Suite
            </a>
        </div>
    </header>

    <main class="main-content">
        <div class="title-section">
            <h1 class="page-title">Threshold Switching Analysis</h1>
            <p style="color: #a0a0a0; font-size: 1.2rem;">Explore Non-Linear I-V Behavior and Snapback Dynamics</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('sweep')">DC Sweep</button>
            <button class="tab" onclick="switchTab('pulse')">Pulse Response</button>
            <button class="tab" onclick="switchTab('statistical')">Statistical Analysis</button>
            <button class="tab" onclick="switchTab('comparison')">State Comparison</button>
        </div>

        <div id="sweep" class="tab-content active">
            <div class="lab-container">
                <div class="controls-panel">
                    <h3 style="color: #c084fc; margin-bottom: 1.5rem;">Sweep Parameters</h3>
                    
                    <div class="state-selector">
                        <button class="state-btn active" onclick="selectState('amorphous')">
                            <i class="fas fa-circle"></i> Amorphous
                        </button>
                        <button class="state-btn" onclick="selectState('crystalline')">
                            <i class="fas fa-gem"></i> Crystalline
                        </button>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            Max Voltage (V)
                            <span class="control-value" id="vmax-value">3.0</span>
                        </label>
                        <input type="range" class="control-slider" id="vmax-slider" 
                               min="0.5" max="5.0" value="3.0" step="0.1">
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            Sweep Rate (V/s)
                            <span class="control-value" id="rate-value">1.0</span>
                        </label>
                        <input type="range" class="control-slider" id="rate-slider" 
                               min="0.1" max="10.0" value="1.0" step="0.1">
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            Series Resistance (kΩ)
                            <span class="control-value" id="rs-value">10</span>
                        </label>
                        <input type="range" class="control-slider" id="rs-slider" 
                               min="1" max="100" value="10" step="1">
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            Compliance Current (mA)
                            <span class="control-value" id="icc-value">1.0</span>
                        </label>
                        <input type="range" class="control-slider" id="icc-slider" 
                               min="0.1" max="10.0" value="1.0" step="0.1">
                    </div>

                    <div class="sweep-mode">
                        <button class="sweep-btn active" onclick="setSweepMode('single')">Single</button>
                        <button class="sweep-btn" onclick="setSweepMode('double')">Double</button>
                        <button class="sweep-btn" onclick="setSweepMode('cyclic')">Cyclic</button>
                    </div>

                    <button class="btn" onclick="runSweep()">
                        <i class="fas fa-play"></i> Run Sweep
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>

                    <div class="info-panel">
                        <h4 style="color: #c084fc;">Key Parameters</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <span style="color: #a0a0a0;">V<sub>th</sub></span>
                                <span style="color: #9333ea; font-weight: bold;" id="vth-display">--</span>
                            </div>
                            <div class="info-item">
                                <span style="color: #a0a0a0;">V<sub>hold</sub></span>
                                <span style="color: #9333ea; font-weight: bold;" id="vhold-display">--</span>
                            </div>
                            <div class="info-item">
                                <span style="color: #a0a0a0;">I<sub>on</sub></span>
                                <span style="color: #9333ea; font-weight: bold;" id="ion-display">--</span>
                            </div>
                            <div class="info-item">
                                <span style="color: #a0a0a0;">I<sub>off</sub></span>
                                <span style="color: #9333ea; font-weight: bold;" id="ioff-display">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="plots-grid">
                    <div class="plot-container full-width">
                        <div id="iv-plot"></div>
                    </div>
                    
                    <div class="plot-container">
                        <div id="power-plot"></div>
                    </div>
                    
                    <div class="plot-container">
                        <div id="resistance-plot"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pulse" class="tab-content">
            <div class="plot-container" style="margin-bottom: 2rem;">
                <div id="pulse-response-plot"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div class="control-group">
                    <label class="control-label">
                        Pulse Amplitude (V)
                        <span class="control-value" id="pulse-amp-value">2.5</span>
                    </label>
                    <input type="range" class="control-slider" id="pulse-amp-slider" 
                           min="0.5" max="5.0" value="2.5" step="0.1">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Pulse Width (ns)
                        <span class="control-value" id="pulse-width-value">100</span>
                    </label>
                    <input type="range" class="control-slider" id="pulse-width-slider" 
                           min="10" max="1000" value="100" step="10">
                </div>
            </div>
            
            <button class="btn" style="width: auto; margin: 2rem auto; display: block; padding: 0.75rem 2rem;" 
                    onclick="simulatePulseResponse()">
                <i class="fas fa-bolt"></i> Simulate Pulse Response
            </button>
        </div>

        <div id="statistical" class="tab-content">
            <div class="plot-container" style="margin-bottom: 2rem;">
                <div id="statistical-plot"></div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn" style="width: auto; padding: 0.75rem 2rem;" onclick="runMonteCarlo()">
                    <i class="fas fa-dice"></i> Run Monte Carlo (1000 samples)
                </button>
            </div>
        </div>

        <div id="comparison" class="tab-content">
            <div class="plot-container">
                <div id="comparison-plot"></div>
            </div>
            
            <div style="margin-top: 2rem;">
                <h3 style="color: #c084fc; text-align: center; margin-bottom: 1rem;">State-Dependent Parameters</h3>
                <table style="width: 100%; background: rgba(20, 20, 20, 0.8); border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(147, 51, 234, 0.2);">
                            <th style="padding: 1rem; text-align: left; color: #c084fc;">Parameter</th>
                            <th style="padding: 1rem; text-align: center; color: #c084fc;">Amorphous</th>
                            <th style="padding: 1rem; text-align: center; color: #c084fc;">Crystalline</th>
                            <th style="padding: 1rem; text-align: center; color: #c084fc;">Ratio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 1rem; border-top: 1px solid rgba(147, 51, 234, 0.1);">R<sub>off</sub> (Ω)</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">1×10⁶</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">1×10³</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">1000</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-top: 1px solid rgba(147, 51, 234, 0.1);">V<sub>th</sub> (V)</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">1.2</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">0.3</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">4</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-top: 1px solid rgba(147, 51, 234, 0.1);">V<sub>hold</sub> (V)</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">0.8</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">0.2</td>
                            <td style="padding: 1rem; text-align: center; border-top: 1px solid rgba(147, 51, 234, 0.1);">4</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentState = 'amorphous';
        let sweepMode = 'single';
        let sweepData = {};

        // Device parameters
        const deviceParams = {
            amorphous: {
                R_off: 1e6,  // Ohms
                R_on: 1e3,   // Ohms
                V_th: 1.2,   // V
                V_hold: 0.8, // V
                beta: 5      // Snapback sharpness
            },
            crystalline: {
                R_off: 1e3,  // Ohms
                R_on: 100,   // Ohms
                V_th: 0.3,   // V
                V_hold: 0.2, // V
                beta: 3
            }
        };

        // Initialize on load
        window.addEventListener('load', () => {
            initializePlots();
            runSweep();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Update plots when switching
            if (tabName === 'pulse') simulatePulseResponse();
            if (tabName === 'statistical') updateStatisticalPlot();
            if (tabName === 'comparison') updateComparisonPlot();
        }

        function selectState(state) {
            currentState = state;
            document.querySelectorAll('.state-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            runSweep();
        }

        function setSweepMode(mode) {
            sweepMode = mode;
            document.querySelectorAll('.sweep-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function runSweep() {
            const Vmax = parseFloat(document.getElementById('vmax-slider').value);
            const Rs = parseFloat(document.getElementById('rs-slider').value) * 1000; // Convert to Ohms
            const Icc = parseFloat(document.getElementById('icc-slider').value) * 1e-3; // Convert to A
            
            const params = deviceParams[currentState];
            
            // Generate voltage sweep
            const V_applied = [];
            const I_device = [];
            const V_device = [];
            const R_device = [];
            const P_device = [];
            
            // Forward sweep
            for (let Va = 0; Va <= Vmax; Va += 0.01) {
                V_applied.push(Va);
                
                // Calculate device current with threshold switching
                let I, V, R;
                
                if (Va < params.V_th) {
                    // Below threshold - high resistance
                    R = params.R_off;
                    I = Va / (Rs + R);
                    V = I * R;
                } else {
                    // Above threshold - snapback occurs
                    const snapback_factor = 1 / (1 + Math.exp(-params.beta * (Va - params.V_th)));
                    R = params.R_off * (1 - snapback_factor) + params.R_on * snapback_factor;
                    I = Math.min((Va - params.V_hold) / Rs, Icc);
                    V = Va - I * Rs;
                }
                
                I_device.push(I * 1000); // Convert to mA
                V_device.push(V);
                R_device.push(R);
                P_device.push(V * I * 1000); // mW
            }
            
            // Add reverse sweep if double or cyclic
            let V_applied_full = [...V_applied];
            let I_device_full = [...I_device];
            let V_device_full = [...V_device];
            
            if (sweepMode === 'double' || sweepMode === 'cyclic') {
                for (let i = V_applied.length - 2; i >= 0; i--) {
                    V_applied_full.push(V_applied[i]);
                    
                    // Hysteresis in reverse sweep
                    const Va = V_applied[i];
                    let I, V;
                    
                    if (Va > params.V_hold) {
                        // Still in ON state
                        const R = params.R_on;
                        I = Math.min(Va / (Rs + R), Icc);
                        V = I * R;
                    } else {
                        // Return to OFF state
                        const R = params.R_off;
                        I = Va / (Rs + R);
                        V = I * R;
                    }
                    
                    I_device_full.push(I * 1000);
                    V_device_full.push(V);
                }
            }
            
            // Update plots
            updateIVPlot(V_device_full, I_device_full);
            updatePowerPlot(V_applied, P_device);
            updateResistancePlot(V_applied, R_device);
            
            // Update parameters display
            const Vth_idx = V_applied.findIndex(v => v >= params.V_th);
            const Vth_measured = Vth_idx >= 0 ? V_device[Vth_idx] : params.V_th;
            const Ion = Math.max(...I_device);
            const Ioff = I_device[Math.floor(I_device.length * 0.1)];
            
            document.getElementById('vth-display').textContent = Vth_measured.toFixed(2) + ' V';
            document.getElementById('vhold-display').textContent = params.V_hold.toFixed(2) + ' V';
            document.getElementById('ion-display').textContent = Ion.toFixed(2) + ' mA';
            document.getElementById('ioff-display').textContent = Ioff.toFixed(3) + ' mA';
            
            // Store data
            sweepData = { V_applied, V_device: V_device_full, I_device: I_device_full, R_device, P_device };
        }

        function updateIVPlot(V, I) {
            const trace = {
                x: V,
                y: I,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#9333ea', width: 2 },
                name: currentState.charAt(0).toUpperCase() + currentState.slice(1)
            };
            
            const layout = {
                title: 'I-V Characteristics with Threshold Switching',
                xaxis: { 
                    title: 'Device Voltage (V)',
                    gridcolor: '#333',
                    zeroline: true,
                    zerolinecolor: '#666'
                },
                yaxis: { 
                    title: 'Device Current (mA)',
                    gridcolor: '#333',
                    zeroline: true,
                    zerolinecolor: '#666'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                showlegend: true,
                shapes: [
                    {
                        type: 'line',
                        x0: deviceParams[currentState].V_th,
                        x1: deviceParams[currentState].V_th,
                        y0: 0,
                        y1: Math.max(...I),
                        line: { color: 'rgba(255, 107, 107, 0.5)', width: 1, dash: 'dash' }
                    },
                    {
                        type: 'line',
                        x0: deviceParams[currentState].V_hold,
                        x1: deviceParams[currentState].V_hold,
                        y0: 0,
                        y1: Math.max(...I),
                        line: { color: 'rgba(107, 255, 107, 0.5)', width: 1, dash: 'dash' }
                    }
                ],
                annotations: [
                    {
                        x: deviceParams[currentState].V_th,
                        y: Math.max(...I) * 0.9,
                        text: 'V<sub>th</sub>',
                        showarrow: false,
                        font: { color: '#ff6b6b', size: 12 }
                    },
                    {
                        x: deviceParams[currentState].V_hold,
                        y: Math.max(...I) * 0.8,
                        text: 'V<sub>hold</sub>',
                        showarrow: false,
                        font: { color: '#6bff6b', size: 12 }
                    }
                ]
            };
            
            Plotly.newPlot('iv-plot', [trace], layout, {responsive: true});
        }

        function updatePowerPlot(V, P) {
            const trace = {
                x: V,
                y: P,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#ff6b6b', width: 2 },
                fill: 'tozeroy',
                fillcolor: 'rgba(255, 107, 107, 0.2)'
            };
            
            const layout = {
                title: 'Power Dissipation',
                xaxis: { title: 'Applied Voltage (V)', gridcolor: '#333' },
                yaxis: { title: 'Power (mW)', gridcolor: '#333' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' }
            };
            
            Plotly.newPlot('power-plot', [trace], layout, {responsive: true});
        }

        function updateResistancePlot(V, R) {
            const trace = {
                x: V,
                y: R,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#4ecdc4', width: 2 }
            };
            
            const layout = {
                title: 'Dynamic Resistance',
                xaxis: { title: 'Applied Voltage (V)', gridcolor: '#333' },
                yaxis: { 
                    title: 'Resistance (Ω)',
                    type: 'log',
                    gridcolor: '#333'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' }
            };
            
            Plotly.newPlot('resistance-plot', [trace], layout, {responsive: true});
        }

        function simulatePulseResponse() {
            const amplitude = parseFloat(document.getElementById('pulse-amp-slider').value);
            const width = parseFloat(document.getElementById('pulse-width-slider').value);
            
            // Generate time array
            const time = [];
            const voltage = [];
            const current = [];
            
            for (let t = 0; t <= width * 3; t += 0.5) {
                time.push(t);
                
                // Pulse shape
                let V;
                if (t < width * 0.1) {
                    V = amplitude * (t / (width * 0.1)); // Rise
                } else if (t < width * 1.1) {
                    V = amplitude; // Plateau
                } else if (t < width * 1.2) {
                    V = amplitude * (1 - (t - width * 1.1) / (width * 0.1)); // Fall
                } else {
                    V = 0;
                }
                voltage.push(V);
                
                // Current response with delay
                const params = deviceParams[currentState];
                let I;
                if (V < params.V_th) {
                    I = V / params.R_off;
                } else {
                    // Delayed switching
                    const delay = 5; // ns
                    if (t > delay) {
                        I = (V - params.V_hold) / params.R_on;
                    } else {
                        I = V / params.R_off;
                    }
                }
                current.push(I * 1e6); // Convert to µA
            }
            
            const data = [
                {
                    x: time,
                    y: voltage,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Voltage',
                    line: { color: '#9333ea', width: 2 },
                    yaxis: 'y'
                },
                {
                    x: time,
                    y: current,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Current',
                    line: { color: '#ff6b6b', width: 2 },
                    yaxis: 'y2'
                }
            ];
            
            const layout = {
                title: 'Pulse Response Dynamics',
                xaxis: { title: 'Time (ns)', gridcolor: '#333' },
                yaxis: { 
                    title: 'Voltage (V)',
                    gridcolor: '#333',
                    side: 'left'
                },
                yaxis2: {
                    title: 'Current (µA)',
                    gridcolor: '#333',
                    overlaying: 'y',
                    side: 'right'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                showlegend: true
            };
            
            Plotly.newPlot('pulse-response-plot', data, layout, {responsive: true});
        }

        function runMonteCarlo() {
            const samples = 1000;
            const Vth_values = [];
            const Vhold_values = [];
            
            for (let i = 0; i < samples; i++) {
                // Add 10% variation
                const variation = 0.1;
                const Vth = deviceParams[currentState].V_th * (1 + (Math.random() - 0.5) * variation);
                const Vhold = deviceParams[currentState].V_hold * (1 + (Math.random() - 0.5) * variation);
                
                Vth_values.push(Vth);
                Vhold_values.push(Vhold);
            }
            
            const data = [
                {
                    x: Vth_values,
                    type: 'histogram',
                    name: 'V<sub>th</sub> Distribution',
                    marker: { color: '#9333ea' },
                    opacity: 0.7,
                    xaxis: 'x',
                    yaxis: 'y'
                },
                {
                    x: Vhold_values,
                    type: 'histogram',
                    name: 'V<sub>hold</sub> Distribution',
                    marker: { color: '#ff6b6b' },
                    opacity: 0.7,
                    xaxis: 'x2',
                    yaxis: 'y2'
                }
            ];
            
            const layout = {
                title: 'Statistical Distribution (1000 samples)',
                grid: { rows: 2, columns: 1, pattern: 'independent' },
                xaxis: { title: 'V<sub>th</sub> (V)', gridcolor: '#333' },
                xaxis2: { title: 'V<sub>hold</sub> (V)', gridcolor: '#333' },
                yaxis: { title: 'Count', gridcolor: '#333' },
                yaxis2: { title: 'Count', gridcolor: '#333' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                showlegend: true
            };
            
            Plotly.newPlot('statistical-plot', data, layout, {responsive: true});
        }

        function updateStatisticalPlot() {
            // Initialize with empty plot
            const layout = {
                title: 'Click "Run Monte Carlo" to generate statistical data',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' }
            };
            
            Plotly.newPlot('statistical-plot', [], layout, {responsive: true});
        }

        function updateComparisonPlot() {
            const V = [];
            for (let v = 0; v <= 3; v += 0.01) {
                V.push(v);
            }
            
            const traces = [];
            
            ['amorphous', 'crystalline'].forEach(state => {
                const params = deviceParams[state];
                const I = V.map(v => {
                    if (v < params.V_th) {
                        return v / params.R_off * 1000; // mA
                    } else {
                        return Math.min((v - params.V_hold) / params.R_on * 1000, 10); // mA with limit
                    }
                });
                
                traces.push({
                    x: V,
                    y: I,
                    type: 'scatter',
                    mode: 'lines',
                    name: state.charAt(0).toUpperCase() + state.slice(1),
                    line: { width: 2 }
                });
            });
            
            const layout = {
                title: 'State-Dependent I-V Comparison',
                xaxis: { title: 'Voltage (V)', gridcolor: '#333' },
                yaxis: { 
                    title: 'Current (mA)',
                    type: 'log',
                    gridcolor: '#333'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                showlegend: true
            };
            
            Plotly.newPlot('comparison-plot', traces, layout, {responsive: true});
        }

        function initializePlots() {
            const emptyLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                xaxis: { gridcolor: '#333' },
                yaxis: { gridcolor: '#333' }
            };
            
            Plotly.newPlot('iv-plot', [], emptyLayout, {responsive: true});
            Plotly.newPlot('power-plot', [], emptyLayout, {responsive: true});
            Plotly.newPlot('resistance-plot', [], emptyLayout, {responsive: true});
        }

        function exportData() {
            const data = {
                state: currentState,
                parameters: deviceParams[currentState],
                sweep: sweepData
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pcm_iv_${currentState}_${Date.now()}.json`;
            a.click();
        }

        // Update value displays
        document.getElementById('vmax-slider').addEventListener('input', function() {
            document.getElementById('vmax-value').textContent = this.value;
        });

        document.getElementById('rate-slider').addEventListener('input', function() {
            document.getElementById('rate-value').textContent = this.value;
        });

        document.getElementById('rs-slider').addEventListener('input', function() {
            document.getElementById('rs-value').textContent = this.value;
        });

        document.getElementById('icc-slider').addEventListener('input', function() {
            document.getElementById('icc-value').textContent = this.value;
        });

        document.getElementById('pulse-amp-slider').addEventListener('input', function() {
            document.getElementById('pulse-amp-value').textContent = this.value;
        });

        document.getElementById('pulse-width-slider').addEventListener('input', function() {
            document.getElementById('pulse-width-value').textContent = this.value;
        });
    </script>
</body>
</html>