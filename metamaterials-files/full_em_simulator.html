<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full EM Field Simulator - Metamaterials</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { background: #0a0a0a; color: #e5e7eb; }
        .demo-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .control-panel { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 30px; margin-bottom: 30px; }
        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .control-group { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; }
        .control-group label { display: block; color: #a855f7; margin-bottom: 8px; font-weight: 600; }
        .control-group input[type="range"] { width: 100%; margin: 10px 0; }
        .control-group select { width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #e5e7eb; }
        .value-display { background: #8e24aa; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 0.9em; }
        .visualization-panel { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 30px; margin-bottom: 30px; }
        .button-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .sim-button { background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .sim-button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(147,51,234,0.4); }
        .solver-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .solver-tab { padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e5e7eb; cursor: pointer; transition: all 0.3s; }
        .solver-tab.active { background: #8e24aa; border-color: #8e24aa; }
        h1 { color: #f59e0b; text-align: center; }
        h2 { color: #f59e0b; }
        .status-bar { background: rgba(16,185,129,0.2); border: 1px solid #10b981; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand"><a href="../index.html" class="logo">LA</a></div>
            <ul class="nav-menu"><li><a href="../metamaterials-research.html" class="nav-link">← Back</a></li></ul>
        </div>
    </nav>

    <div class="demo-container">
        <h1><i class="fas fa-play-circle"></i> Full Electromagnetic Field Simulator</h1>
        
        <div class="status-bar" id="statusBar">
            <i class="fas fa-info-circle"></i> Ready to simulate. Select parameters and click Run Simulation.
        </div>

        <!-- Solver Selection -->
        <div class="solver-tabs">
            <button class="solver-tab active" onclick="selectSolver(this, 'fdtd')">FDTD Solver</button>
            <button class="solver-tab" onclick="selectSolver(this, 'fem')">FEM Solver</button>
            <button class="solver-tab" onclick="selectSolver(this, 'rcwa')">RCWA Solver</button>
            <button class="solver-tab" onclick="selectSolver(this, 'tmm')">TMM Solver</button>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h2 style="color: #a855f7;">Simulation Parameters</h2>
            
            <div class="control-grid">
                <div class="control-group">
                    <label>Structure Type</label>
                    <select id="structureType" onchange="updateParams()">
                        <option value="srr">Split-Ring Resonator</option>
                        <option value="fishnet">Fishnet</option>
                        <option value="wire">Wire Array</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Unit Cell Size (nm)</label>
                    <input type="range" id="cellSize" min="100" max="1000" value="300" step="10" oninput="updateValue('cellSize')">
                    <span class="value-display" id="cellSizeValue">300</span>
                </div>
                
                <div class="control-group">
                    <label>Feature Size (nm)</label>
                    <input type="range" id="featureSize" min="10" max="200" value="50" step="5" oninput="updateValue('featureSize')">
                    <span class="value-display" id="featureSizeValue">50</span>
                </div>
                
                <div class="control-group">
                    <label>Metal Thickness (nm)</label>
                    <input type="range" id="thickness" min="10" max="100" value="35" step="5" oninput="updateValue('thickness')">
                    <span class="value-display" id="thicknessValue">35</span>
                </div>
                
                <div class="control-group">
                    <label>Max Frequency (THz)</label>
                    <input type="range" id="freqRange" min="0.5" max="10" value="2" step="0.5" oninput="updateValue('freqRange')">
                    <span class="value-display" id="freqRangeValue">2.0</span>
                </div>
                
                <div class="control-group">
                    <label>Grid Resolution</label>
                    <select id="resolution">
                        <option value="coarse">Coarse (λ/10)</option>
                        <option value="medium" selected>Medium (λ/20)</option>
                        <option value="fine">Fine (λ/40)</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button class="sim-button" onclick="runSimulation()">
                    <i class="fas fa-play"></i> Run Simulation
                </button>
                <button class="sim-button" onclick="pauseSimulation()">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="sim-button" onclick="resetSimulation()">
                    <i class="fas fa-redo"></i> Reset
                </button>
                <button class="sim-button" onclick="exportResults()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>

        <!-- 3D Field -->
        <div class="visualization-panel">
            <h2>3D Field Distribution</h2>
            <div id="field3D" style="height: 500px;"></div>
        </div>

        <!-- Field Components -->
        <div class="visualization-panel">
            <h2>Field Components</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div id="exField" style="height: 300px;"></div>
                <div id="eyField" style="height: 300px;"></div>
            </div>
        </div>

        <!-- S-Parameters -->
        <div class="visualization-panel">
            <h2>Scattering Parameters</h2>
            <div id="sparamsPlot" style="height: 400px;"></div>
        </div>

        <!-- Convergence -->
        <div class="visualization-panel">
            <h2>Convergence Monitor</h2>
            <div id="convergencePlot" style="height: 300px;"></div>
        </div>
    </div>

    <script>
        let currentSolver = 'fdtd';
        let simulationRunning = false;
        let animationFrame = 0;
        let animationId = null;
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing EM Simulator...');
            initializeSimulation();
        });
        
        function selectSolver(button, solver) {
            currentSolver = solver;
            document.querySelectorAll('.solver-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            updateStatus('Switched to ' + solver.toUpperCase() + ' solver');
            initializeSimulation();
        }
        
        function updateValue(param) {
            const value = document.getElementById(param).value;
            if (param === 'freqRange') {
                document.getElementById(param + 'Value').textContent = parseFloat(value).toFixed(1);
            } else {
                document.getElementById(param + 'Value').textContent = value;
            }
        }
        
        function updateParams() {
            const structure = document.getElementById('structureType').value;
            updateStatus('Selected structure: ' + structure);
        }
        
        function updateStatus(message) {
            document.getElementById('statusBar').innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
        }
        
        function initializeSimulation() {
            create3DField();
            createFieldComponents();
            createSparamsPlot();
            createConvergencePlot();
        }
        
        function create3DField() {
            const size = 30;
            const x = [], y = [], z = [], values = [];
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    for (let k = 0; k < size; k++) {
                        x.push(i);
                        y.push(j);
                        z.push(k);
                        const r = Math.sqrt((i-15)**2 + (j-15)**2 + (k-15)**2);
                        values.push(Math.sin(r/3 - animationFrame/10) * Math.exp(-r/20));
                    }
                }
            }
            
            const data = [{
                type: 'scatter3d',
                mode: 'markers',
                x: x,
                y: y,
                z: z,
                marker: {
                    size: 3,
                    color: values,
                    colorscale: 'Viridis',
                    opacity: 0.8,
                    colorbar: {
                        title: 'E-field',
                        titlefont: {color: '#9ca3af'},
                        tickfont: {color: '#9ca3af'}
                    }
                }
            }];
            
            const layout = {
                title: {text: currentSolver.toUpperCase() + ' Solver - E-field', font: {color: '#f59e0b'}},
                scene: {
                    xaxis: {title: 'X', gridcolor: '#374151'},
                    yaxis: {title: 'Y', gridcolor: '#374151'},
                    zaxis: {title: 'Z', gridcolor: '#374151'},
                    bgcolor: 'rgba(0,0,0,0)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: {t: 40}
            };
            
            Plotly.newPlot('field3D', data, layout);
        }
        
        function createFieldComponents() {
            const size = 50;
            const exData = [], eyData = [];
            
            for (let i = 0; i < size; i++) {
                const row1 = [], row2 = [];
                for (let j = 0; j < size; j++) {
                    row1.push(Math.sin((i-25)/5) * Math.cos((j-25)/5 - animationFrame/10));
                    row2.push(Math.cos((i-25)/5) * Math.sin((j-25)/5 - animationFrame/10));
                }
                exData.push(row1);
                eyData.push(row2);
            }
            
            const layout = {
                title: {font: {color: '#f59e0b', size: 14}},
                xaxis: {visible: false},
                yaxis: {visible: false},
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: {t: 30, b: 0, l: 0, r: 0}
            };
            
            Plotly.newPlot('exField', [{type: 'heatmap', z: exData, colorscale: 'RdBu', showscale: false}], 
                          {...layout, title: {text: 'Ex Component', font: {color: '#f59e0b', size: 14}}});
            Plotly.newPlot('eyField', [{type: 'heatmap', z: eyData, colorscale: 'RdBu', showscale: false}], 
                          {...layout, title: {text: 'Ey Component', font: {color: '#f59e0b', size: 14}}});
        }
        
        function createSparamsPlot() {
            const freq = [];
            const s11 = [];
            const s21 = [];
            const maxFreq = parseFloat(document.getElementById('freqRange').value);
            
            for (let f = 0.1; f <= maxFreq; f += 0.05) {
                freq.push(f);
                s11.push(0.1 + 0.05 * Math.sin(10 * f) + Math.random() * 0.02);
                s21.push(0.9 - 0.1 * Math.exp(-(f-1)**2) + Math.random() * 0.02);
            }
            
            const data = [
                {x: freq, y: s21, name: '|S21| Transmission', type: 'scatter', line: {color: 'green', width: 2}},
                {x: freq, y: s11, name: '|S11| Reflection', type: 'scatter', line: {color: 'red', width: 2}}
            ];
            
            const layout = {
                title: {text: 'S-Parameters', font: {color: '#f59e0b'}},
                xaxis: {title: 'Frequency (THz)', gridcolor: '#374151', titlefont: {color: '#9ca3af'}},
                yaxis: {title: 'Magnitude', gridcolor: '#374151', titlefont: {color: '#9ca3af'}},
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0.1)',
                legend: {bgcolor: 'rgba(0,0,0,0.5)', bordercolor: '#374151', borderwidth: 1, font: {color: '#e5e7eb'}}
            };
            
            Plotly.newPlot('sparamsPlot', data, layout);
        }
        
        function createConvergencePlot() {
            const iterations = [];
            const error = [];
            
            for (let i = 0; i < 50; i++) {
                iterations.push(i);
                error.push(Math.exp(-i/10) * (1 + Math.random() * 0.1));
            }
            
            const data = [{x: iterations, y: error, type: 'scatter', line: {color: 'cyan', width: 2}}];
            
            const layout = {
                title: {text: 'Convergence', font: {color: '#f59e0b'}},
                xaxis: {title: 'Iteration', gridcolor: '#374151', titlefont: {color: '#9ca3af'}},
                yaxis: {title: 'Error', type: 'log', gridcolor: '#374151', titlefont: {color: '#9ca3af'}},
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0.1)'
            };
            
            Plotly.newPlot('convergencePlot', data, layout);
        }
        
        function runSimulation() {
            if (simulationRunning) return;
            simulationRunning = true;
            updateStatus('Simulation running...');
            animate();
        }
        
        function animate() {
            if (!simulationRunning) return;
            animationFrame++;
            
            // Update visualizations
            create3DField();
            createFieldComponents();
            
            // Update convergence
            if (animationFrame % 10 === 0) {
                const newError = Math.exp(-animationFrame/20) * (1 + Math.random() * 0.1);
                Plotly.extendTraces('convergencePlot', {x: [[animationFrame/2]], y: [[newError]]}, [0]);
            }
            
            animationId = requestAnimationFrame(animate);
        }
        
        function pauseSimulation() {
            simulationRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            updateStatus('Simulation paused');
        }
        
        function resetSimulation() {
            simulationRunning = false;
            animationFrame = 0;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            updateStatus('Simulation reset');
            initializeSimulation();
        }
        
        function exportResults() {
            const freq = [];
            const s11 = [];
            const s21 = [];
            const maxFreq = parseFloat(document.getElementById('freqRange').value);
            
            for (let f = 0.1; f <= maxFreq; f += 0.1) {
                freq.push(f.toFixed(2));
                s11.push((0.1 + 0.05 * Math.sin(10 * f)).toFixed(4));
                s21.push((0.9 - 0.1 * Math.exp(-(f-1)**2)).toFixed(4));
            }
            
            let csvContent = "Frequency(THz),S11,S21\n";
            for (let i = 0; i < freq.length; i++) {
                csvContent += freq[i] + "," + s11[i] + "," + s21[i] + "\n";
            }
            
            const blob = new Blob([csvContent], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'em_simulation_' + currentSolver + '.csv';
            a.click();
            
            updateStatus('Results exported as CSV');
        }
    </script>
</body>
</html>
