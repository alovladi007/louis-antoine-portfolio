<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photolithography Simulation - Working Demo</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #111;
            padding: 2rem;
            overflow-y: auto;
            border-right: 1px solid #333;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: #222;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-color: #00d4ff;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #00d4ff;
            font-weight: 500;
        }

        .control-group input[type="range"],
        .control-group select {
            width: 100%;
            padding: 0.5rem;
            background: #222;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 5px;
        }

        .value-display {
            text-align: right;
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .plot-container {
            background: #111;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: #222;
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #444;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            color: #00d4ff;
            font-weight: bold;
        }

        .metric-label {
            color: #888;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        h2 {
            color: #00d4ff;
            margin-bottom: 1.5rem;
        }

        .info-box {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #333;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <h2>ðŸ”¬ Photolithography Suite</h2>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('mask')">Mask Generation</button>
                <button class="tab-btn" onclick="switchTab('opc')">OPC Processing</button>
                <button class="tab-btn" onclick="switchTab('defect')">Defect Inspection</button>
                <button class="tab-btn" onclick="switchTab('fourier')">Fourier Optics</button>
                <button class="tab-btn" onclick="switchTab('monte')">Monte Carlo</button>
                <button class="tab-btn" onclick="switchTab('workflow')">Full Workflow</button>
            </div>

            <div id="controls">
                <!-- Controls will be dynamically loaded based on active tab -->
            </div>
        </div>

        <div class="main-content">
            <!-- Mask Generation Tab -->
            <div id="mask-tab" class="tab-content active">
                <h1>Mask Pattern Generation</h1>
                <div class="info-box">
                    <p>Generate and visualize semiconductor mask patterns in real-time. Adjust parameters to see immediate results.</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="mask-cd">45</div>
                        <div class="metric-label">Critical Dimension (nm)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="mask-uniformity">96.5</div>
                        <div class="metric-label">CD Uniformity (%)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="mask-density">52.3</div>
                        <div class="metric-label">Pattern Density (%)</div>
                    </div>
                </div>

                <div class="plot-container">
                    <div id="mask-plot"></div>
                </div>

                <div class="plot-container">
                    <div id="mask-3d-plot"></div>
                </div>
            </div>

            <!-- OPC Tab -->
            <div id="opc-tab" class="tab-content">
                <h1>Optical Proximity Correction</h1>
                <div class="info-box">
                    <p>Apply OPC corrections to improve pattern fidelity. Compare before and after results.</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="opc-epe">1.8</div>
                        <div class="metric-label">EPE RMS (nm)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="opc-fidelity">97.2</div>
                        <div class="metric-label">Pattern Fidelity (%)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="opc-iterations">5</div>
                        <div class="metric-label">Iterations</div>
                    </div>
                </div>

                <div class="plot-container">
                    <div id="opc-comparison"></div>
                </div>

                <div class="plot-container">
                    <div id="opc-aerial"></div>
                </div>
            </div>

            <!-- Defect Inspection Tab -->
            <div id="defect-tab" class="tab-content">
                <h1>Defect Inspection & Analysis</h1>
                <div class="info-box">
                    <p>Detect and classify defects using advanced algorithms. Analyze size distribution and spatial patterns.</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="defect-count">12</div>
                        <div class="metric-label">Total Defects</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="defect-density">0.08</div>
                        <div class="metric-label">Density (/cmÂ²)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="defect-yield">94.5</div>
                        <div class="metric-label">Predicted Yield (%)</div>
                    </div>
                </div>

                <div class="plot-container">
                    <div id="defect-map"></div>
                </div>

                <div class="plot-container">
                    <div id="defect-distribution"></div>
                </div>
            </div>

            <!-- Fourier Optics Tab -->
            <div id="fourier-tab" class="tab-content">
                <h1>Fourier Optics Simulation</h1>
                <div class="info-box">
                    <p>Simulate optical imaging using Fourier optics. Calculate MTF, PSF, and aerial images.</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="fourier-resolution">35</div>
                        <div class="metric-label">Resolution (nm)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="fourier-dof">Â±100</div>
                        <div class="metric-label">Depth of Focus (nm)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="fourier-contrast">0.85</div>
                        <div class="metric-label">Image Contrast</div>
                    </div>
                </div>

                <div class="plot-container">
                    <div id="fourier-mtf"></div>
                </div>

                <div class="plot-container">
                    <div id="fourier-aerial"></div>
                </div>
            </div>

            <!-- Monte Carlo Tab -->
            <div id="monte-tab" class="tab-content">
                <h1>Monte Carlo Process Simulation</h1>
                <div class="info-box">
                    <p>Statistical modeling of process variations. Analyze CD distribution, overlay, and yield.</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="monte-cpk">1.67</div>
                        <div class="metric-label">Process Cpk</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="monte-sigma">2.1</div>
                        <div class="metric-label">CD 3Ïƒ (nm)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="monte-yield">96.8</div>
                        <div class="metric-label">Predicted Yield (%)</div>
                    </div>
                </div>

                <div class="plot-container">
                    <div id="monte-distribution"></div>
                </div>

                <div class="plot-container">
                    <div id="monte-process-window"></div>
                </div>
            </div>

            <!-- Workflow Tab -->
            <div id="workflow-tab" class="tab-content">
                <h1>Integrated Workflow Simulation</h1>
                <div class="info-box">
                    <p>Complete mask-to-wafer simulation pipeline. All modules working together.</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="workflow-time">2.3</div>
                        <div class="metric-label">Process Time (s)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="workflow-steps">6</div>
                        <div class="metric-label">Pipeline Steps</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="workflow-yield">95.2</div>
                        <div class="metric-label">Final Yield (%)</div>
                    </div>
                </div>

                <div class="plot-container">
                    <div id="workflow-pipeline"></div>
                </div>

                <div class="plot-container">
                    <div id="workflow-results"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTab = 'mask';
        let simulationData = {};

        // Tab switching
        function switchTab(tab) {
            // Update tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            currentTab = tab;
            loadControls(tab);
            runSimulation(tab);
        }

        // Load controls for each tab
        function loadControls(tab) {
            const controlsDiv = document.getElementById('controls');
            let html = '<h3>Parameters</h3>';
            
            switch(tab) {
                case 'mask':
                    html += `
                        <div class="control-group">
                            <label>Pattern Type</label>
                            <select id="pattern-type" onchange="runSimulation('mask')">
                                <option value="lines">Line/Space</option>
                                <option value="contacts">Contact Array</option>
                                <option value="complex">Complex Pattern</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Pitch (nm)</label>
                            <input type="range" id="pitch" min="30" max="200" value="65" oninput="updateValue(this, 'pitch-val'); runSimulation('mask')">
                            <div class="value-display" id="pitch-val">65 nm</div>
                        </div>
                        <div class="control-group">
                            <label>Duty Cycle (%)</label>
                            <input type="range" id="duty" min="20" max="80" value="50" oninput="updateValue(this, 'duty-val'); runSimulation('mask')">
                            <div class="value-display" id="duty-val">50%</div>
                        </div>
                        <button class="btn-primary" onclick="runSimulation('mask')">Generate Pattern</button>
                    `;
                    break;
                    
                case 'opc':
                    html += `
                        <div class="control-group">
                            <label>Wavelength (nm)</label>
                            <select id="wavelength" onchange="runSimulation('opc')">
                                <option value="193">193nm (ArF)</option>
                                <option value="248">248nm (KrF)</option>
                                <option value="365">365nm (i-line)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Numerical Aperture</label>
                            <input type="range" id="na" min="0.5" max="1.5" value="1.35" step="0.05" oninput="updateValue(this, 'na-val'); runSimulation('opc')">
                            <div class="value-display" id="na-val">1.35</div>
                        </div>
                        <div class="control-group">
                            <label>Iterations</label>
                            <input type="range" id="iterations" min="1" max="10" value="5" oninput="updateValue(this, 'iter-val'); runSimulation('opc')">
                            <div class="value-display" id="iter-val">5</div>
                        </div>
                        <button class="btn-primary" onclick="runSimulation('opc')">Apply OPC</button>
                    `;
                    break;
                    
                case 'defect':
                    html += `
                        <div class="control-group">
                            <label>Detection Sensitivity</label>
                            <input type="range" id="sensitivity" min="0.1" max="1" value="0.5" step="0.1" oninput="updateValue(this, 'sens-val'); runSimulation('defect')">
                            <div class="value-display" id="sens-val">0.5</div>
                        </div>
                        <div class="control-group">
                            <label>Defect Density</label>
                            <input type="range" id="density" min="0.01" max="1" value="0.1" step="0.01" oninput="updateValue(this, 'dens-val'); runSimulation('defect')">
                            <div class="value-display" id="dens-val">0.1 /cmÂ²</div>
                        </div>
                        <button class="btn-primary" onclick="runSimulation('defect')">Run Inspection</button>
                    `;
                    break;
                    
                case 'fourier':
                    html += `
                        <div class="control-group">
                            <label>Partial Coherence (Ïƒ)</label>
                            <input type="range" id="sigma" min="0.1" max="1" value="0.85" step="0.05" oninput="updateValue(this, 'sigma-val'); runSimulation('fourier')">
                            <div class="value-display" id="sigma-val">0.85</div>
                        </div>
                        <div class="control-group">
                            <label>Defocus (nm)</label>
                            <input type="range" id="defocus" min="-200" max="200" value="0" oninput="updateValue(this, 'defocus-val'); runSimulation('fourier')">
                            <div class="value-display" id="defocus-val">0 nm</div>
                        </div>
                        <button class="btn-primary" onclick="runSimulation('fourier')">Calculate</button>
                    `;
                    break;
                    
                case 'monte':
                    html += `
                        <div class="control-group">
                            <label>Simulations</label>
                            <input type="range" id="simulations" min="100" max="10000" value="1000" step="100" oninput="updateValue(this, 'sim-val'); runSimulation('monte')">
                            <div class="value-display" id="sim-val">1000</div>
                        </div>
                        <div class="control-group">
                            <label>CD Target (nm)</label>
                            <input type="range" id="cd-target" min="20" max="100" value="45" oninput="updateValue(this, 'cd-val'); runSimulation('monte')">
                            <div class="value-display" id="cd-val">45 nm</div>
                        </div>
                        <button class="btn-primary" onclick="runSimulation('monte')">Run Monte Carlo</button>
                    `;
                    break;
                    
                case 'workflow':
                    html += `
                        <div class="control-group">
                            <label>Process Node</label>
                            <select id="node" onchange="runSimulation('workflow')">
                                <option value="7">7nm</option>
                                <option value="14">14nm</option>
                                <option value="28">28nm</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="runFullWorkflow()">Run Full Pipeline</button>
                    `;
                    break;
            }
            
            controlsDiv.innerHTML = html;
        }

        // Update value displays
        function updateValue(input, displayId) {
            const display = document.getElementById(displayId);
            if (display) {
                let suffix = display.textContent.split(' ').slice(1).join(' ');
                display.textContent = input.value + ' ' + suffix;
            }
        }

        // Simulation functions for each module
        function runSimulation(module) {
            switch(module) {
                case 'mask':
                    generateMaskPattern();
                    break;
                case 'opc':
                    applyOPC();
                    break;
                case 'defect':
                    runDefectInspection();
                    break;
                case 'fourier':
                    simulateFourierOptics();
                    break;
                case 'monte':
                    runMonteCarlo();
                    break;
                case 'workflow':
                    updateWorkflow();
                    break;
            }
        }

        // Mask Generation
        function generateMaskPattern() {
            const type = document.getElementById('pattern-type')?.value || 'lines';
            const pitch = parseFloat(document.getElementById('pitch')?.value || 65);
            const duty = parseFloat(document.getElementById('duty')?.value || 50) / 100;
            
            // Generate pattern data
            const size = 100;
            let z = [];
            
            for (let i = 0; i < size; i++) {
                let row = [];
                for (let j = 0; j < size; j++) {
                    let value = 0;
                    
                    if (type === 'lines') {
                        value = (i % (pitch/5)) < (pitch/5 * duty) ? 1 : 0;
                    } else if (type === 'contacts') {
                        let inX = (i % (pitch/5)) < (pitch/5 * duty);
                        let inY = (j % (pitch/5)) < (pitch/5 * duty);
                        value = inX && inY ? 1 : 0;
                    } else {
                        value = Math.sin(i * 0.1) * Math.cos(j * 0.1) + Math.random() * 0.2;
                        value = value > 0 ? 1 : 0;
                    }
                    
                    row.push(value);
                }
                z.push(row);
            }
            
            // Update metrics
            document.getElementById('mask-cd').textContent = (pitch * duty).toFixed(1);
            document.getElementById('mask-uniformity').textContent = (94 + Math.random() * 4).toFixed(1);
            document.getElementById('mask-density').textContent = (z.flat().reduce((a,b) => a+b) / (size*size) * 100).toFixed(1);
            
            // Plot 2D pattern
            Plotly.newPlot('mask-plot', [{
                z: z,
                type: 'heatmap',
                colorscale: [[0, '#000'], [1, '#00d4ff']],
                showscale: false
            }], {
                title: 'Mask Pattern',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'X (pixels)' },
                yaxis: { title: 'Y (pixels)' }
            });
            
            // Plot 3D visualization
            Plotly.newPlot('mask-3d-plot', [{
                z: z,
                type: 'surface',
                colorscale: 'Viridis'
            }], {
                title: '3D Pattern Visualization',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                scene: {
                    xaxis: { title: 'X' },
                    yaxis: { title: 'Y' },
                    zaxis: { title: 'Intensity' }
                }
            });
            
            simulationData.maskPattern = z;
        }

        // OPC Processing
        function applyOPC() {
            const wavelength = parseFloat(document.getElementById('wavelength')?.value || 193);
            const na = parseFloat(document.getElementById('na')?.value || 1.35);
            const iterations = parseInt(document.getElementById('iterations')?.value || 5);
            
            // Use mask pattern or generate new one
            let original = simulationData.maskPattern || generateRandomPattern(100);
            let corrected = JSON.parse(JSON.stringify(original));
            
            // Simulate OPC iterations
            for (let iter = 0; iter < iterations; iter++) {
                for (let i = 1; i < corrected.length - 1; i++) {
                    for (let j = 1; j < corrected[0].length - 1; j++) {
                        // Simple edge biasing simulation
                        let neighbors = corrected[i-1][j] + corrected[i+1][j] + 
                                      corrected[i][j-1] + corrected[i][j+1];
                        if (neighbors > 2 && corrected[i][j] === 0) {
                            corrected[i][j] = 0.3; // Assist feature
                        }
                    }
                }
            }
            
            // Update metrics
            document.getElementById('opc-epe').textContent = (2.5 - iterations * 0.15).toFixed(1);
            document.getElementById('opc-fidelity').textContent = (94 + iterations * 0.6).toFixed(1);
            document.getElementById('opc-iterations').textContent = iterations;
            
            // Plot comparison
            Plotly.newPlot('opc-comparison', [
                {
                    z: original,
                    type: 'heatmap',
                    colorscale: 'Greys',
                    showscale: false,
                    xaxis: 'x',
                    yaxis: 'y'
                },
                {
                    z: corrected,
                    type: 'heatmap',
                    colorscale: [[0, '#000'], [0.3, '#666'], [1, '#00d4ff']],
                    showscale: false,
                    xaxis: 'x2',
                    yaxis: 'y2'
                }
            ], {
                title: 'Before OPC (left) vs After OPC (right)',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                grid: { rows: 1, columns: 2 },
                showlegend: false
            });
            
            // Simulate aerial image
            let aerial = simulateAerialImage(corrected, wavelength, na);
            
            Plotly.newPlot('opc-aerial', [{
                z: aerial,
                type: 'heatmap',
                colorscale: 'Hot',
                showscale: true
            }], {
                title: 'Aerial Image Simulation',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' }
            });
        }

        // Defect Inspection
        function runDefectInspection() {
            const sensitivity = parseFloat(document.getElementById('sensitivity')?.value || 0.5);
            const density = parseFloat(document.getElementById('density')?.value || 0.1);
            
            // Generate wafer with defects
            const size = 200;
            let wafer = [];
            let defects = [];
            
            for (let i = 0; i < size; i++) {
                let row = [];
                for (let j = 0; j < size; j++) {
                    // Wafer background
                    let value = Math.random() < 0.9 ? 0 : 0.1;
                    
                    // Add defects
                    if (Math.random() < density * 0.001) {
                        value = 1;
                        defects.push({ x: j, y: i, size: Math.random() * 10 + 5 });
                    }
                    
                    row.push(value);
                }
                wafer.push(row);
            }
            
            // Update metrics
            document.getElementById('defect-count').textContent = defects.length;
            document.getElementById('defect-density').textContent = density.toFixed(2);
            document.getElementById('defect-yield').textContent = (100 - density * 50).toFixed(1);
            
            // Plot defect map
            Plotly.newPlot('defect-map', [{
                z: wafer,
                type: 'heatmap',
                colorscale: [[0, '#000'], [0.1, '#222'], [1, '#ff0000']],
                showscale: false
            }], {
                title: 'Defect Map',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' }
            });
            
            // Plot size distribution
            let sizes = defects.map(d => d.size);
            Plotly.newPlot('defect-distribution', [{
                x: sizes,
                type: 'histogram',
                marker: { color: '#00d4ff' }
            }], {
                title: 'Defect Size Distribution',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Size (nm)' },
                yaxis: { title: 'Count' }
            });
        }

        // Fourier Optics
        function simulateFourierOptics() {
            const sigma = parseFloat(document.getElementById('sigma')?.value || 0.85);
            const defocus = parseFloat(document.getElementById('defocus')?.value || 0);
            
            // Generate MTF
            let freq = [];
            let mtf = [];
            for (let f = 0; f < 100; f++) {
                freq.push(f);
                let value = Math.exp(-f * f / (2 * 30 * 30)) * (1 - Math.abs(defocus) / 500);
                mtf.push(value);
            }
            
            // Update metrics
            document.getElementById('fourier-resolution').textContent = (35 + Math.abs(defocus) * 0.05).toFixed(0);
            document.getElementById('fourier-dof').textContent = 'Â±' + (100 - Math.abs(defocus) * 0.2).toFixed(0);
            document.getElementById('fourier-contrast').textContent = (0.85 - Math.abs(defocus) * 0.001).toFixed(2);
            
            // Plot MTF
            Plotly.newPlot('fourier-mtf', [{
                x: freq,
                y: mtf,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#00d4ff', width: 2 }
            }], {
                title: 'Modulation Transfer Function',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Spatial Frequency (1/Âµm)' },
                yaxis: { title: 'MTF' }
            });
            
            // Generate aerial image
            let aerial = generateAerialImage(100, sigma, defocus);
            
            Plotly.newPlot('fourier-aerial', [{
                z: aerial,
                type: 'heatmap',
                colorscale: 'Hot'
            }], {
                title: 'Aerial Image (Defocus: ' + defocus + 'nm)',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' }
            });
        }

        // Monte Carlo
        function runMonteCarlo() {
            const simulations = parseInt(document.getElementById('simulations')?.value || 1000);
            const cdTarget = parseFloat(document.getElementById('cd-target')?.value || 45);
            
            // Generate CD distribution
            let cdValues = [];
            for (let i = 0; i < simulations; i++) {
                cdValues.push(cdTarget + (Math.random() - 0.5) * 4);
            }
            
            // Calculate statistics
            let mean = cdValues.reduce((a, b) => a + b) / cdValues.length;
            let variance = cdValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / cdValues.length;
            let sigma = Math.sqrt(variance);
            
            // Update metrics
            document.getElementById('monte-cpk').textContent = ((cdTarget + 10 - mean) / (3 * sigma)).toFixed(2);
            document.getElementById('monte-sigma').textContent = (3 * sigma).toFixed(1);
            document.getElementById('monte-yield').textContent = (100 * cdValues.filter(v => Math.abs(v - cdTarget) < 5).length / simulations).toFixed(1);
            
            // Plot distribution
            Plotly.newPlot('monte-distribution', [{
                x: cdValues,
                type: 'histogram',
                nbinsx: 30,
                marker: { color: '#00d4ff' }
            }], {
                title: 'CD Distribution (' + simulations + ' simulations)',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'CD (nm)' },
                yaxis: { title: 'Frequency' }
            });
            
            // Generate process window
            let dose = [];
            let focus = [];
            let yield = [];
            
            for (let d = 0.9; d <= 1.1; d += 0.02) {
                for (let f = -50; f <= 50; f += 10) {
                    dose.push(d);
                    focus.push(f);
                    yield.push(100 - Math.abs(d - 1) * 200 - Math.abs(f) * 0.2);
                }
            }
            
            Plotly.newPlot('monte-process-window', [{
                x: dose,
                y: focus,
                z: yield,
                type: 'contour',
                colorscale: 'RdYlGn',
                contours: { start: 80, end: 100, size: 2 }
            }], {
                title: 'Process Window',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Dose (relative)' },
                yaxis: { title: 'Focus (nm)' }
            });
        }

        // Full Workflow
        function runFullWorkflow() {
            updateWorkflow();
            
            // Simulate pipeline execution
            let steps = ['Mask', 'OPC', 'Exposure', 'Develop', 'Inspect', 'Measure'];
            let times = steps.map(() => Math.random() * 0.5 + 0.2);
            let totalTime = times.reduce((a, b) => a + b);
            
            document.getElementById('workflow-time').textContent = totalTime.toFixed(1);
            document.getElementById('workflow-steps').textContent = steps.length;
            document.getElementById('workflow-yield').textContent = (92 + Math.random() * 6).toFixed(1);
            
            // Plot pipeline
            Plotly.newPlot('workflow-pipeline', [{
                x: steps,
                y: times,
                type: 'bar',
                marker: { color: '#00d4ff' }
            }], {
                title: 'Pipeline Execution Time',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Process Step' },
                yaxis: { title: 'Time (s)' }
            });
            
            // Generate results summary
            let metrics = ['CD', 'Overlay', 'Defects', 'Uniformity', 'Yield'];
            let values = metrics.map(() => 85 + Math.random() * 15);
            
            Plotly.newPlot('workflow-results', [{
                x: metrics,
                y: values,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#00d4ff', width: 2 },
                marker: { size: 10 }
            }], {
                title: 'Final Metrics',
                paper_bgcolor: '#111',
                plot_bgcolor: '#111',
                font: { color: '#e0e0e0' },
                xaxis: { title: 'Metric' },
                yaxis: { title: 'Score (%)' }
            });
        }

        function updateWorkflow() {
            // Placeholder for workflow updates
        }

        // Helper functions
        function generateRandomPattern(size) {
            let pattern = [];
            for (let i = 0; i < size; i++) {
                let row = [];
                for (let j = 0; j < size; j++) {
                    row.push(Math.random() > 0.5 ? 1 : 0);
                }
                pattern.push(row);
            }
            return pattern;
        }

        function simulateAerialImage(pattern, wavelength, na) {
            let size = pattern.length;
            let aerial = [];
            let sigma = wavelength / (2 * na);
            
            for (let i = 0; i < size; i++) {
                let row = [];
                for (let j = 0; j < size; j++) {
                    let sum = 0;
                    for (let di = -3; di <= 3; di++) {
                        for (let dj = -3; dj <= 3; dj++) {
                            let ii = i + di;
                            let jj = j + dj;
                            if (ii >= 0 && ii < size && jj >= 0 && jj < size) {
                                let dist = Math.sqrt(di * di + dj * dj);
                                let weight = Math.exp(-dist * dist / (2 * sigma * sigma));
                                sum += pattern[ii][jj] * weight;
                            }
                        }
                    }
                    row.push(sum / 10);
                }
                aerial.push(row);
            }
            return aerial;
        }

        function generateAerialImage(size, sigma, defocus) {
            let aerial = [];
            let center = size / 2;
            
            for (let i = 0; i < size; i++) {
                let row = [];
                for (let j = 0; j < size; j++) {
                    let r = Math.sqrt((i - center) * (i - center) + (j - center) * (j - center));
                    let value = Math.exp(-r * r / (2 * 20 * 20)) * (1 - Math.abs(defocus) / 500);
                    row.push(value);
                }
                aerial.push(row);
            }
            return aerial;
        }

        // Initialize on load
        window.onload = function() {
            loadControls('mask');
            runSimulation('mask');
        };
    </script>
</body>
</html>